// This file has been autogenerated from a class added in the UI designer.

using System;
using System.Collections.Generic;
using System.IO;
using CloudCoin_SafeScan;
using Foundation;
using MiniZip.ZipArchive;
using UIKit;

namespace CloudCoinIOS
{
	public partial class ExportViewController : BaseFormSheet
	{
		private UIColor borderColor = UIColor.FromRGB(122, 134, 148);
		private nint desiredSum;
		private Safe safe;
		private CoinStack exportCoins;
        private AppDelegate appDelegate;

		public ExportViewController(IntPtr handle) : base(handle)
		{
		}

		public override void ViewDidLoad()
		{
			base.ViewDidLoad();

			InitializeProperties();

			InitializeMethods();
		}

		private void InitializeProperties()
		{
			SetBorderColor(pickerOne);
			SetBorderColor(pickerFive);
			SetBorderColor(picker25);
			SetBorderColor(picker100);
			SetBorderColor(picker250);

			try
			{
				safe = Safe.Instance;
			}
			catch (Exception ex)
			{
				safe = null;
				Console.WriteLine(ex.Message);
			}

            var oneQuantity = safe.Ones.FractionedQuantity + safe.Ones.GoodQuantity;
            var fiveQuantity = safe.Fives.FractionedQuantity + safe.Fives.GoodQuantity;
            var quartersQuantity = safe.Quarters.FractionedQuantity + safe.Quarters.GoodQuantity;
            var hundredsQuantity = safe.Hundreds.FractionedQuantity + safe.Hundreds.GoodQuantity;
            var kiloQuantity = safe.KiloQuarters.FractionedQuantity + safe.KiloQuarters.GoodQuantity;

            pickerOne.Model = new CoinPickerViewModel(this, oneQuantity);
            pickerFive.Model = new CoinPickerViewModel(this, fiveQuantity);
            picker25.Model = new CoinPickerViewModel(this, quartersQuantity);
            picker100.Model = new CoinPickerViewModel(this, hundredsQuantity);
            picker250.Model = new CoinPickerViewModel(this, kiloQuantity);

            lblOne.Text = "of " + oneQuantity.ToString();
            lblFive.Text = "of " + fiveQuantity.ToString();
            lbl25.Text = "of " + quartersQuantity.ToString();
            lbl100.Text = "of " + hundredsQuantity.ToString();
            lbl250.Text = "of " + kiloQuantity.ToString();

			lblSumInSafe.Text = Safe.Instance.Contents.SumInStack.ToString();
			desiredSum = 0;
			PickerSelectedHandler();
		}

		public void PickerSelectedHandler()
		{
			desiredSum = pickerOne.SelectedRowInComponent(0)
					  + pickerFive.SelectedRowInComponent(0) * 5
					  + picker25.SelectedRowInComponent(0) * 25
					  + picker100.SelectedRowInComponent(0) * 100
					  + picker250.SelectedRowInComponent(0) * 250;

			btnExport.SetTitle("Export " + desiredSum.ToString(), UIControlState.Normal);
		}

		private void SetBorderColor(UIView view)
		{
			view.Layer.MasksToBounds = true;
			view.Layer.BorderColor = borderColor.CGColor;
		}

		private void InitializeMethods()
		{
			btnCancel.TouchUpInside += (sender, e) =>
			{
				RemoveAnimate();
			};

			btnExport.TouchUpInside += async (sender, e) =>
			{
				bool isJson = segmentFormat.SelectedSegment == 1 ? true : false;
				exportCoins = GetExportCoins();

                appDelegate = (AppDelegate)UIApplication.SharedApplication.Delegate;

                int isUnZip = 1;
                if (appDelegate.IsSupportZip())
                    isUnZip = await ShowAlert("Export", "Would you like to export as zip file?", new string[]{ "Yes", "No" });

				var isExported = safe.SaveOutStack(GetExportCoins(), (int)desiredSum, isJson, lblNote.Text);

				if (isExported)
				{
                    var fileDataList = new List<NSObject>();

                    if (isUnZip == 0)
                    {
                        var zipViewController = (ZipPasswordViewController)Storyboard.InstantiateViewController("ZipPasswordViewController");
						zipViewController.ShowInView(View, true);
                        var enterPassword = await zipViewController.GetEnterPassword();
                        zipViewController.RemoveAnimate();

                        var zip = new ZipArchive();
                        var zipPath = appDelegate.ExportDir + "/cloudcoin.zip";
                        zip.CreateZipFile(zipPath, enterPassword);
						foreach (var path in safe.ExportedPaths)
						{
                            zip.AddFile(path, Path.GetFileName(path));
						}
                        fileDataList.Add(NSUrl.FromFilename(zipPath));
                        zip.CloseZipFile();
					} 
                    else 
                    {
						foreach (var path in safe.ExportedPaths)
						{
							fileDataList.Add(NSUrl.FromFilename(path));
						}
                    }

                    var activityViewController = new UIActivityViewController(fileDataList.ToArray(), null);

					if (UIDevice.CurrentDevice.UserInterfaceIdiom == UIUserInterfaceIdiom.Pad)
					{
						activityViewController.PopoverPresentationController.SourceView = this.View;
					}

					activityViewController.CompletionHandler += SetCompletionHandler;

					PresentViewController(activityViewController, true, null);
				}
				else
				{
					await ShowAlert("Export", "Nothing to export!\n", new string[] {"Ok"});
				}
			};
		}

		private void SetCompletionHandler(NSString act, bool success)
		{
			if (success)
			{
				safe.Contents.Remove(exportCoins);
				safe.onSafeContentChanged(new EventArgs());
				safe.Save();

				RemoveAnimate();

				Console.WriteLine("success");
			}
			else
			{
				Console.WriteLine("cancel");
			}
		}

		private CoinStack GetExportCoins()
		{
			var coinStack = new CoinStack();
            coinStack.Add(safe.Contents.AuthCoinOnes, safe.Contents.AuthCoinOnes.Count);
            coinStack.Add(safe.Contents.AuthCoinFives, safe.Contents.AuthCoinFives.Count);
            coinStack.Add(safe.Contents.AuthCoinQuarters, safe.Contents.AuthCoinQuarters.Count);
            coinStack.Add(safe.Contents.AuthCoinHundreds, safe.Contents.AuthCoinHundreds.Count);
            coinStack.Add(safe.Contents.AuthCoinKiloQuarters, safe.Contents.AuthCoinKiloQuarters.Count);
			return coinStack;
		}
	}

	public class CoinPickerViewModel : UIPickerViewModel
	{
		private int count;
		private ExportViewController exportViewController;

		public CoinPickerViewModel(ExportViewController exportViewController, int count)
		{
			this.count = count;
			this.exportViewController = exportViewController;
		}

		public override nint GetRowsInComponent(UIPickerView pickerView, nint component)
		{
			return count + 1;
		}

		public override string GetTitle(UIPickerView pickerView, nint row, nint component)
		{
			return row.ToString();
		}

		public override nint GetComponentCount(UIPickerView pickerView)
		{
			return 1;
		}

		public override void Selected(UIPickerView pickerView, nint row, nint component)
		{
			exportViewController.PickerSelectedHandler();
		}
	}
}
